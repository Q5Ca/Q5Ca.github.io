---
layout: post
title: "Pháº§n 2: PHÃ‚N TÃCH Lá»– Há»”NG RCE Cá»¦A MOODLE (CVE-2018-1133)"
categories: [CVE]
tags: [Moodle, CVE-2018-1133, RCE]
excerpt: "An issue was discovered in Moodle 3.x. A Teacher creating a Calculated question can intentionally cause remote code execution on the server, aka eval injection."
post-thumb: post-thumb-0.png
comments: true
color-theme: "#ad0a0a"
css-file: phan-2-phan-tich
js-files: [post]
---
<p>Pháº§n 2 nÃ y mÃ¬nh Ä‘Ã£ Ä‘á»ƒ trÃ¬ trá»‡ Ä‘áº¿n 2 tuáº§n rá»“i, cá»© má»—i láº§n má»Ÿ lÃªn Ä‘á»‹nh viáº¿t tiáº¿p thÃ¬ Ã´i sao mÃ  nÃ³ ngÆ°á»£ng tay tháº¿, cÃ¢u chá»¯ nÃ³ cháº¡y cmn Ä‘i Ä‘Ã¢u máº¥t. NhÆ°ng hÃ´m nay há»«ng há»±c khÃ­ tháº¿ vÃ¬ vá»«a Ä‘Æ°á»£c gia nháº­p má»™t team ctf, trong lÃ²ng Ä‘áº§y tin tÆ°á»Ÿng vá» tÆ°Æ¡ng lai tÆ°Æ¡i sÃ¡ng phÃ­a trÆ°á»›c. NÃªn háº¡ quyáº¿t tÃ¢m cá»‘ng hiáº¿n gÃ¬ Ä‘Ã³ cho Ä‘á»iâ€¦</p>
<p>Okii lÃªn nháº¡c tÃ­ cho sung ğŸ˜€</p>
{% include youtube.html src="https://www.youtube-nocookie.com/embed/2IE3-CYBM_s" %}
<p>Pháº§n 1 mÃ¬nh Ä‘Ã£ giá»›i thiá»‡u qua vá» moodle vÃ  lá»— há»•ng nÃ y. Pháº§n 2 nÃ y mÃ¬nh sáº½ táº­p trung vÃ o phÃ¢n tÃ­ch lá»— há»•ng.</p>
<p>Trong <a href="https://blog.ripstech.com/2018/moodle-remote-code-execution/"target="_blank" rel="noopener noreferrer">bÃ i phÃ¢n tÃ­ch cá»§a ripstech</a>, tÃ¡c giáº£ Ä‘Ã£ chá»‰ ra lá»— há»•ng nÃ y náº±m á»Ÿ pháº§n táº¡o cÃ¢u há»i cho há»c viÃªn cá»§a moodle. Cá»¥ thá»ƒ lÃ  dáº¡ng cÃ¢u há»i <a href="https://docs.moodle.org/35/en/Calculated_question_type"target="_blank"rel="noreferrer noopener">calculated question</a>. ÄÃ¢y lÃ  dáº¡ng cÃ¢u há»i mÃ  cÃ¢u há»i vÃ  Ä‘Ã¡p Ã¡n cÃ³ dáº¡ng giá»‘ng nhau nhÆ°ng sá»‘ liá»‡u Ä‘Æ°á»£c moodle tá»± Ä‘á»™ng táº¡o ra báº±ng cÃ¡ch chá»n random tá»« táº­p sá»‘ liá»‡u do ngÆ°á»i ra Ä‘á» Ä‘áº·t. VÃ­ dá»¥ ngÆ°á»i ra Ä‘á» muá»‘n há»c sinh tráº£ lá»i cÃ¢u tÃ­nh diá»‡n tÃ­ch má»™t hÃ¬nh chá»¯ nháº­t cho chiá»u dÃ i, chiá»u rá»™ng thuá»™c táº­p tá»« 1 Ä‘áº¿n 10. ThÃ¬ moodle sáº½ táº¡o ngáº«u nhiÃªn 1 cÃ¢u há»i dáº¡ng nhÆ° chiá»u dÃ i 3, chiá»u rá»™ng 2 vÃ  cÃ¢u tráº£ lá»i náº¿u lÃ  6 thÃ¬ sáº½ Ä‘Æ°á»£c tÃ­nh Ä‘iá»ƒm. NhÆ° váº­y sáº½ ngÄƒn há»c viÃªn sao chÃ©p Ä‘Ã¡p Ã¡n cá»§a nhau vÃ¬ má»—i ngÆ°á»i cÃ³ má»™t cÃ¢u há»i giá»‘ng dáº¡ng nhÆ°ng cÃ³ sá»‘ liá»‡u khÃ¡c nhau.</p>
<p>Lá»— há»•ng nÃ y khÃ¡ phá»©c táº¡p, mÃ¬nh sáº½ cá»‘ gáº¯ng phÃ¢n tÃ­ch rÃµ rÃ ng nháº¥t vá»›i kháº£ nÄƒng cÃ³ thá»ƒ.</p>
<p>TrÆ°á»›c khi Ä‘i vÃ o viá»‡c khai thÃ¡c, ta hÃ£y xem chá»©c nÄƒng nÃ y khi hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng sáº½ nhÆ° tháº¿ nÃ o, hiá»ƒu sÆ¡ qua cÃ¡ch developer Ä‘Ã£ láº­p trÃ¬nh nÃ³. Biáº¿t Ä‘Æ°á»£c nhá»¯ng Ä‘iá»u nÃ y, sau khi Ä‘Ã£ khai thÃ¡c Ä‘Æ°á»£c ta cÅ©ng hiá»ƒu developer Ä‘Ã£ máº¯c lá»—i gÃ¬ dáº«n Ä‘áº¿n lá»— há»•ng. Ta báº¯t Ä‘áº§u báº±ng viá»‡c táº¡o má»™t user cÃ³ quyá»n teacher, vÃ  táº¡o má»™t cÃ¢u há»i dáº¡ng calculated.</p>
<p>Äá»ƒ táº¡o thÃªm user, báº¡n Ä‘Äƒng nháº­p báº±ng quyá»n admin rá»“i tÃ¬m pháº§n adduser á»Ÿ menu bÃªn trÃ¡i pháº§n site admin. Sau Ä‘Ã³ táº¡o 1 course rá»“i assign user vá»«a táº¡o lÃ  teacher cá»§a course Ä‘Ã³. ThoÃ¡t ra Ä‘Äƒng nháº­p vÃ o user vá»«a táº¡o ta sáº½ cÃ³ quyá»n táº¡o cÃ¢u há»i cho course vá»«a táº¡o. MÃ¬nh Ä‘Ã£ táº¡o user lÃ  cÃ´ giÃ¡o tháº£o vÃ  dáº¡y mÃ´n sinh há»c. Sau má»™t vÃ i thao tÃ¡c chuá»™t thÃ¬ ta Ä‘áº¿n Ä‘Æ°á»£c mÃ n hÃ¬nh táº¡o cÃ¢u há»i calculated hoáº·c báº¡n cÃ³ thá»ƒ  vÃ o url nÃ y luÃ´n cho nhanh: <span class="font-italic">/moodle/question/edit.php?courseid=2</span></p>
<img src="/assets/images/40.png" alt="">
<p>Sau khi lÃ m theo hÆ°á»›ng dáº«n <a href="https://docs.moodle.org/36/en/Calculated_question_type"target="_blank"rel="noreferrer noopener">nÃ y</a> cuá»‘i cÃ¹ng mÃ¬nh cÅ©ng táº¡o Ä‘Æ°á»£c má»™t cÃ¢u há»i. QuÃ¡ trÃ¬nh táº¡o yÃªu cáº§u pháº£i cáº¥u hÃ¬nh nhiá»u thuá»™c tÃ­nh nhÆ°: sai sá»‘ Ä‘Ã¡p Ã¡n cho phÃ©p, táº­p giÃ¡ trá»‹ cá»§a cÃ¢u há»i, Ä‘iá»ƒmâ€¦khÃ¡ máº¥t thá»i gian vÃ  gÃ¢y bá»±c mÃ¬nh náº¿u khÃ´ng quen. VÃ¬ tÃ­nh cháº¥t bÃ i viáº¿t nÃªn mÃ¬nh chá»‰ táº­p trung vÃ o pháº§n thuá»™c tÃ­nh máº¥u chá»‘t váº¥n Ä‘á» lÃ  cÃ´ng thá»©c tÃ­nh Ä‘Ã¡p Ã¡n</p>
<img src="/assets/images/41.png" alt="">
<p>ÄÃ¢y lÃ  Ä‘Ã¡p Ã¡n cÃ³ giÃ¡ trá»‹ lÃ  tá»•ng cá»§a hai biáº¿n a vÃ  b. Äá»ƒ biá»ƒu diá»…n cÃ´ng thá»©c tÃ­nh giÃ¡ trá»‹, ta dÃ¹ng kÃ­ hiá»‡u: tÃªn biáº¿n Ä‘áº·t trong cáº·p dáº¥u ngoáº·c {}. CÃ¡i nÃ y mÃ¬nh sáº½ gá»i lÃ  placeholder. Sau khi cáº¥u hÃ¬nh cÃ¡c thuá»™c tÃ­nh cÃ²n láº¡i, ta Ä‘Æ°á»£c cÃ¢u há»i nhÆ° tháº¿ nÃ y</p>
<img src="/assets/images/42.png" alt="">
<img src="/assets/images/43.png" alt="">
<p>Ban Ä‘áº§u hÆ°á»›ng tiáº¿p cáº­n cá»§a mÃ¬nh lÃ  trace tá»«ng dÃ²ng code, tá»« dÃ²ng code Ä‘áº§u tiÃªn cá»§a file mÃ  data post lÃªn (file /question/question.php) xem input Ä‘Æ°á»£c xá»­ lÃ­ tháº¿ nÃ o. NhÆ°ng lÃ m nhÆ° tháº¿ ráº¥t máº¥t thá»i gian vÃ¬ Ä‘áº§u tiÃªn script load config, check csrf, check quyá»n user,â€¦ rá»“i linh tinh nhiá»u thá»© xong má»›i parse data cá»§a ta. Cho nÃªn mÃ¬nh Ä‘á»•i sang chiáº¿n thuáº­t lÃ  Ä‘áº·t break point á»Ÿ hÃ m quan trá»ng nÃ y thÃ´i.</p>
<p>ÄÃ¢y lÃ  hÃ m cÃ³ nhiá»‡m vá»¥ eval biá»ƒu thá»©c Ä‘á»ƒ ra Ä‘Ã¡p Ã¡n Ä‘Ãºng, dÃ¹ng Ä‘á»ƒ so sÃ¡nh vá»›i Ä‘Ã¡p Ã¡n do há»c sinh ná»™p. TrÆ°á»›c khi Ä‘Æ°a vÃ o eval, 2 placeholder trong biá»ƒu thá»©c Ä‘Æ°á»£c thay báº±ng sá»‘ báº¥t kÃ¬ do moodle táº¡o báº±ng hÃ m <span class="font-italic">substitute_variables</span> vÃ  check filter báº±ng hÃ m <span class="font-italic">qtype_calculated_find_formula</span></p>
<img src="/assets/images/44.png" alt="">
<p>HÃ m <span class="font-italic">substitute_variables</span> thay cÃ¡c placeholder báº±ng cÃ¡c giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng trong tham sá»‘ array dataset. dataset lÃ  máº£ng cÃ¡c giÃ¡ trá»‹ báº¥t kÃ¬ Ä‘Ã£ Ä‘Æ°á»£c moodle táº¡o tÆ°Æ¡ng á»©ng vá»›i tá»«ng placeholder, á»Ÿ Ä‘Ã¢y 1.8 cho a vÃ  2.3 cho b.</p>
<img src="/assets/images/45.png" alt="">
<img src="/assets/images/481.png" alt="">
<p>NhÆ° váº­y sau khi thay 2 placeholder, biá»ƒu thá»©c thÃ nh 1.8 + 2.3</p>
<p>Sau Ä‘Ã³ biá»ƒu thá»©c Ä‘Æ°á»£c Ä‘Æ°a qua hÃ m qtype_calculated_find_formula Ä‘á»ƒ check cÃ¡c kÃ­ tá»± nguy hiá»ƒm. HÃ m nÃ y cÃ³  2 Ä‘iá»ƒm cáº§n chÃº Ã½. Thá»© nháº¥t lÃ </p>
<img src="/assets/images/46.png" alt="">
<p>NÃ³ dÃ¹ng regex tÃ¬m cÃ¡c Ä‘oáº¡n cÃ³ dáº¡ng </p>
<img src="/assets/images/explain.PNG" alt="" style="width: 900px;">
<p>rá»“i thay báº±ng kÃ­ tá»± 1. hmmâ€¦ Nhá»¯ng Ä‘oáº¡n Ä‘Æ°á»£c tÃ¬m vÃ  thay tháº¿ cÃ³ dáº¡ng má»™t placeholder Ä‘Ãºng khÃ´ng. Váº­y viá»‡c thay tháº¿ khÃ´ng há»£p lÃ­ láº¯m nhá»‰ vÃ¬ cÃ¡c place holder trong formula cÅ©ng Ä‘Ã£ Ä‘Æ°á»£c thay báº±ng giÃ¡ trá»‹ sá»‘ sau khi qua hÃ m substitute_variables rá»“i mÃ . ÄÃ¢y sáº½ lÃ  má»™t máº¯t xÃ­ch thÃº vá»‹. LÆ°u Ã½ thÃªm lÃ  viá»‡c thay tháº¿ chá»‰ cÃ³ tÃ¡c dá»¥ng trong hÃ m filter, cÃ²n formula váº« Ä‘Æ°á»£c giá»¯ nguyÃªn.</p>
<img src="/assets/images/47.png" alt="">
<p>Äoáº¡n nÃ y sáº½ giá»›i háº¡n cÃ¡c kÃ­ tá»± cÃ²n láº¡i trong $formula lÃ  </p>
{% highlight plaintext linenos %}-+/*%>:^\~<!â€“?=&|!.0-9eE{% endhighlight %}
<p>Hiá»‡n giá» $formula lÃ  1.8 + 2.3 nÃªn cháº¯c cháº¯n qua filter. Káº¿t quáº£ lá»‡nh eval nhÆ° tháº¿ nÃ y</p>
<img src="/assets/images/49.png" alt="">
<p>Náº¿u vi pháº¡m hÃ m sáº½ tráº£ vá» false vÃ  formula khÃ´ng Ä‘áº¿n Ä‘Æ°á»£c eval. Váº­y lÃ  moodle Ä‘Ã£ cháº·n cÃ¡c kÃ­ tá»± ráº¥t cáº§n thiáº¿t cho viá»‡c exploit nhÆ° ( ) Ä‘á»ƒ gá»i hÃ m, â€œ Ä‘á»ƒ gá»i systemâ€¦., nhÆ°ng cÃ³ 1 Ä‘iá»ƒm sÃ¡ng lÃ  ta cÃ³ thá»ƒ dÃ¹ng kÃ­ tá»± comment // hoáº·c /*</p>
<p class="font-weight-bold">Má»¥c tiÃªu cá»§a ta lÃ  lÃ m sao táº¡o 1 formula chá»©a payload, payload Ä‘Æ°á»£c báº£o toÃ n sau khi qua substitute_variables, khÃ´ng bá»‹ thay báº±ng 1 sá»‘ báº¥t kÃ¬ sau Ä‘Ã³ bypass Ä‘Æ°á»£c check trong qtype_calculated_find_formula Ä‘á»ƒ Ä‘áº¿n Ä‘Æ°á»£c eval.</p>
<p>Cáº§n pháº£i quay láº¡i hÃ m substitute_variables má»™t chÃºt. HÃ m nÃ y nháº­n 1 tham sá»‘ lÃ  dataset vÃ  thay cÃ¡c placeholder báº±ng cÃ¡ch tÃ¬m cÃ¡c index tÆ°Æ¡ng á»©ng vá»›i placeholder. Tháº¿ náº¿u place holder cá»§a ta khÃ´ng cÃ³ trong dataset thÃ¬ nÃ³ khÃ´ng bá»‹ thay Ä‘Ãºng khÃ´ng. => Pháº£i lÃ m sao Ä‘á»ƒ moodle nháº­n diá»‡n sai placeholder. => CÃ¡ch lÃ m lÃ  táº¡o 1 biá»ƒu thá»©c cÃ³ placeholder lá»“ng nhau nhÆ° tháº¿ nÃ y.</p>
<img src="/assets/images/56.png" alt="">
<img src="/assets/images/50.png" alt="">
<p>NhÆ° váº­y moodle nháº­n diá»‡n a vÃ  b lÃ  2 placeholder. LÃ­ do táº¡i sao thÃ¬ mÃ¬nh khÃ´ng rÃµ vÃ¬ khÃ´ng tÃ¬m hiá»ƒu xem array dataset Ä‘Æ°á»£c táº¡o tháº¿ nÃ o. Cá»© coi nÃ³ lÃ </p>
<img src="/assets/images/mgc.gif" alt="">
<p>Váº­y Ä‘áº§u tiÃªn placeholder {b} Ä‘Æ°á»£c thay báº±ng giÃ¡ trá»‹ 1.8 vÃ  biá»ƒu thá»©c trá»Ÿ thÃ nh {a1.8} . NÃ³ Ä‘Ã£ thÃ nh 1 placeholder má»›i  vÃ  sáº½ khÃ´ng Ä‘Æ°á»£c thay tháº¿ vÃ¬ Ä‘Ã¢u cÃ³ placeholder Ä‘Ã³ trong dataset. Khi Ä‘áº¿n hÃ m check filter nÃ³ nhÆ° tháº¿ nÃ y</p>
<img src="/assets/images/51.png" alt="">
<p>Giá» thÃ¬ Ä‘áº§u xuÃ´i Ä‘uÃ´i lá»t rá»“i, vÃ¬ {a1.8} thá»a mÃ£n tÃ¬m kiáº¿m trong pháº§n Ä‘áº§u cá»§a hÃ m qtype_calculated_find_formula  nÃªn nÃ³ sáº½ Ä‘Æ°á»£c thay báº±ng kÃ­ tá»± â€˜1â€™ vÃ  qua Ä‘Æ°á»£c filter.</p>
<img src="/assets/images/53.png" alt="">
<p>Khi Ä‘áº¿n eval, biá»ƒu thá»©c váº«n giá»¯ nguyÃªn lÃ  {a1.8} => Ta cÃ³ thá»ƒ Ä‘áº·t cÃ¡c kÃ­ tá»± bá»‹ filter nhÆ° tháº¿ nÃ y vÃ  bypass Ä‘Æ°á»£c.</p>
<img src="/assets/images/52.png" alt="">
<p>Láº¯p ghÃ©p láº¡i, ta Ä‘Æ°á»£c ká»‹ch báº£n tháº¿ nÃ y:</p>
<p class="font-weight-bold">Táº¡o Ä‘Ã¡p Ã¡n cÃ³ dáº¡ng {(payload){xyz}}, tÃ¬m cÃ¡ch comment Ä‘á»ƒ payload khi Ä‘áº¿n eval Ä‘Ãºng cÃº phÃ¡p vÃ  Ä‘Æ°á»£c thá»±c thi. </p>
<img src="/assets/images/541.png" alt="">
<p>VÃ  ta Ä‘Ã£ cÃ³ RCE</p>
<img src="/assets/images/55.png" alt="">
<p>NhÆ° váº­y ta Ä‘Ã£ hiá»ƒu nguyÃªn lÃ­ cá»§a cve nÃ y Ä‘Ãºng khÃ´ng. MÃ¬nh xin dá»«ng láº¡i táº¡i Ä‘Ã¢y. Náº¿u báº¡n cÃ³ há»©ng thÃº tiáº¿n sÃ¢u hÆ¡n ná»¯a cÃ³ thá»ƒ Ä‘á»c bÃ i phÃ¢n tÃ­ch cá»§a chÃ­nh tÃ¡c giáº£ <a href="https://blog.ripstech.com/2018/moodle-remote-code-execution/#developing-a-bypass" target="_blank"rel="noreferrer noopener">https://blog.ripstech.com/2018/moodle-remote-code-execution/#developing-a-bypass</a>. Thá»±c táº¿ lÃ  sau khi tÃ¡c giáº£ report, moodle Ä‘Ã£ fix vÃ i láº§n xong tÃ¡c giáº£ láº¡i bypass Ä‘Æ°á»£c ğŸ˜</p>